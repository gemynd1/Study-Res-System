<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//ibatis.apache.org//DTD Mapper 3.0//EN" "http://ibatis.apache.org/dtd/ibatis-3-mapper.dtd">
<mapper namespace="com.project.SnakeDev.mapper.CommunityMapper">

    <select id="ViewCommunity" resultType="com.project.SnakeDev.vo.CommunityVo">
        <![CDATA[
        SELECT * FROM (
                          SELECT
                              c.*,
                              COUNT(ts.COMIDX) AS GroupCount
                          FROM
                              tbl_community c
                                  LEFT JOIN
                              tbl_TogetherStudy ts
                              ON
                                  c.COMIDX = ts.COMIDX
                          WHERE c.COMCATEIDX = 1
                            AND c.COMDELDATE = TO_DATE('9999-12-31', 'YYYY-MM-DD')
                          GROUP BY
                              c.COMIDX, c.COMCATEIDX, c.MIDX, c.COMTITLE, c.COMCONTENT, c.COMREGDATE, c.COMDELDATE, c.COMUPDATE, c.COMINTODATE, c.COMTOCOUNT, c.COMSTARTDATE, c.COMENDDATE, c.COMPLACE, c.COMZIPCODE, c.COMADDRESS, c.COMREPORTCOUNT
                          ORDER BY
                              c.COMIDX DESC
                      ) WHERE ROWNUM <= 3

        UNION ALL

        SELECT * FROM (
                          SELECT
                              c.*,
                              COUNT(ts.COMIDX) AS GroupCount
                          FROM
                              tbl_community c
                                  LEFT JOIN
                              tbl_TogetherStudy ts
                              ON
                                  c.COMIDX = ts.COMIDX
                          WHERE c.COMCATEIDX = 2
                            AND c.COMDELDATE = TO_DATE('9999-12-31', 'YYYY-MM-DD')
                          GROUP BY
                              c.COMIDX, c.COMCATEIDX, c.MIDX, c.COMTITLE, c.COMCONTENT, c.COMREGDATE, c.COMDELDATE, c.COMUPDATE, c.COMINTODATE, c.COMTOCOUNT, c.COMSTARTDATE, c.COMENDDATE, c.COMPLACE, c.COMZIPCODE, c.COMADDRESS, c.COMREPORTCOUNT
                          ORDER BY
                              c.COMIDX DESC
                      ) WHERE ROWNUM <= 3
        ]]>
    </select>

    <select id="ViewCurrentCommunity" resultType="com.project.SnakeDev.vo.CommunityVo" parameterType="String">
        <![CDATA[
        SELECT * FROM (
            SELECT
                c.*,
                COUNT(ts.COMIDX) AS GroupCount
            FROM
                tbl_community c
            LEFT JOIN
                tbl_TogetherStudy ts
            ON
                c.COMIDX = ts.COMIDX
            WHERE comcateidx = (select comcateidx from tbl_community_category where comcatename = #{currentCategory})
                and comdeldate = TO_DATE('9999-12-31', 'YYYY-MM-DD')
            GROUP BY
                c.COMIDX, c.COMCATEIDX, c.MIDX, c.COMTITLE, c.COMCONTENT, c.COMREGDATE, c.COMDELDATE, c.COMUPDATE, c.COMINTODATE, c.COMTOCOUNT, c.COMSTARTDATE, c.COMENDDATE, c.COMPLACE, c.COMZIPCODE, c.COMADDRESS, c.COMREPORTCOUNT
            ORDER BY
                c.COMIDX DESC
            )
        WHERE ROWNUM <= 2
        ]]>
    </select>

    <select id="ViewCommunityCategory" resultType="com.project.SnakeDev.vo.CommunityCategoryVo">
        select * from tbl_community_category where comcateusestate = 'Y'
    </select>

    <select id="ViewPost" resultType="com.project.SnakeDev.vo.CommunityVo" parameterType="String">
        select
            c.COMIDX,
            c.COMCATEIDX,
            c.MIDX,
            c.COMTITLE,
            c.COMCONTENT,
            TO_CHAR(c.COMREGDATE, 'YYYY-MM-DD') AS COMREGDATE,
            c.COMDELDATE,
            c.COMUPDATE,
            c.COMINTODATE,
            c.COMTOCOUNT,
            c.COMSTARTDATE,
            c.COMENDDATE,
            c.COMPLACE,
            c.COMZIPCODE,
            c.COMADDRESS,
            c.COMREPORTCOUNT,
            m.MemberName,
            m.MemberId,
            cc.ComCateName as comCategoryName,
            (SELECT MAX(CCGroupNum) FROM tbl_community_comment WHERE comidx = #{comIdx}) AS maxCCGroupNum
        from
            tbl_community c
        join
            tbl_member m on c.midx = m.midx
        left join
            tbl_community_category cc on c.COMCATEIDX = cc.COMCATEIDX
        where
            c.comidx = #{comIdx}
        group by
            c.COMIDX, c.COMCATEIDX, c.MIDX, c.COMTITLE, c.COMCONTENT, c.COMREGDATE, c.COMDELDATE, c.COMUPDATE, c.COMINTODATE, c.COMTOCOUNT, c.COMSTARTDATE, c.COMENDDATE, c.COMPLACE, c.COMZIPCODE, c.COMADDRESS, c.COMREPORTCOUNT, m.MemberName, m.MemberId, cc.ComCateName
    </select>

    <select id="ViewGroupMember_forPost" resultType="com.project.SnakeDev.vo.TogetherStudyVo" parameterType="String">
        select
            ts.*,
            m.MemberName,
            m.MemberId
        from
            tbl_TogetherStudy ts
        join
            tbl_member m on ts.midx = m.midx
        where
            ts.comidx = #{comIdx}
    </select>

    <select id="ViewPost_forPostRewrite" resultType="com.project.SnakeDev.vo.CommunityVo" parameterType="String">
        select
            c.*,
            cc.COMCATENAME as comCategoryName
        from
            tbl_community c
                join tbl_member m on c.midx = m.midx
                join tbl_community_category cc on c.comcateidx = cc.comcateidx
        where
            c.comidx = #{comIdx}
    </select>

    <select id="ViewGroupMember_forPostRewrite" resultType="com.project.SnakeDev.vo.TogetherStudyVo" parameterType="String">
        select
            ts.*,
            m.MemberName
        from
            tbl_TogetherStudy ts
                join tbl_member m on ts.midx = m.midx
        where
            comidx = #{comIdx}
    </select>

    <select id="ViewComment" resultType="com.project.SnakeDev.vo.Community_CommentVo" parameterType="map">
        WITH CommentWithDenseRank AS (
            SELECT
                tcc.*,
                tm.membername,
                tm.memberId,
                DENSE_RANK() OVER (ORDER BY tcc.CCGROUPNUM DESC) AS dense_rank
            FROM
                tbl_community_comment tcc
                    JOIN
                tbl_member tm ON tcc.midx = tm.midx
            WHERE
                tcc.comidx = #{comIdx}
                and tcc.ccdeldate = TO_DATE('9999-12-31', 'YYYY-MM-DD')
        )
        SELECT
            *
        FROM
            CommentWithDenseRank
        WHERE
            dense_rank BETWEEN (#{currentPage} * #{commentSize} - (#{commentSize} - (#{commentSize} - 1))) AND (#{currentPage} * #{commentSize})
    </select>

    <select id="ViewCommentSize" resultType="int" parameterType="String">
        WITH RankedComments AS (
            SELECT
                tcc.*,
                DENSE_RANK() OVER (ORDER BY tcc.CCGROUPNUM DESC) AS dense_rank
            FROM
                tbl_community_comment tcc
            WHERE
                tcc.comidx = #{comIdx}
                and tcc.ccdeldate = TO_DATE('9999-12-31', 'YYYY-MM-DD')
        )
        SELECT
            NVL(CEIL(MAX(dense_rank) / 2), 0) AS pageSize
        FROM
            RankedComments
    </select>

    <select id="ViewMoreCommunity" resultType="com.project.SnakeDev.vo.CommunityVo" parameterType="map">
        SELECT
            c.*,
            COUNT(ts.COMIDX) AS GroupCount
        FROM
            tbl_community c
        LEFT JOIN
            tbl_TogetherStudy ts
        ON
            c.COMIDX = ts.COMIDX
        WHERE
            comcateidx = (select comcateidx from tbl_community_category where comcatename = #{currentCategory})
            and comdeldate = TO_DATE('9999-12-31', 'YYYY-MM-DD')
        GROUP BY
            c.COMIDX, c.COMCATEIDX, c.MIDX, c.COMTITLE, c.COMCONTENT, c.COMREGDATE, c.COMDELDATE, c.COMUPDATE, c.COMINTODATE, c.COMTOCOUNT, c.COMSTARTDATE, c.COMENDDATE, c.COMPLACE, c.COMZIPCODE, c.COMADDRESS, c.COMREPORTCOUNT
        ORDER BY
            c.COMIDX DESC
        OFFSET #{int_ContentNumber} ROWS FETCH NEXT 1 ROWS ONLY
    </select>

    <select id="ViewCommunity_size" parameterType="String" resultType="int">
        select count(*) from tbl_community where comcateidx = (select comcateidx from tbl_community_category where comcatename = #{currentCategory}) and comdeldate = TO_DATE('9999-12-31', 'YYYY-MM-DD')
    </select>

    <select id="ViewStudyroom" resultType="com.project.SnakeDev.vo.StudyGInfoVo">
        select
            s.*,
            listagg(g.sgimg, ', ') within group (order by g.sgiidx) as studyGImgs
        from
            tbl_studyginfo s
        left join
            tbl_studygimg g on s.sgiidx = g.sgiidx
        group by
            s.sgiidx, s.scidx, s.sginum, s.sgiusestate, s.sgicontent1, s.sgicontent2
    </select>

    <update id="updateCommunity" parameterType="map">
        update tbl_community
            set ComIdx = #{ComIdx, jdbcType=INTEGER},
                ComCateIdx = (select ComCateIdx from tbl_community_category where comCateName = #{comCategoryName, jdbcType=VARCHAR}),
                ComTitle = #{ComTitle, jdbcType=VARCHAR},
                ComContent = #{ComContent, jdbcType=VARCHAR},
                ComRegDate = TO_DATE(#{ComRegDate, jdbcType=VARCHAR}, 'YYYY-MM-DD HH24:MI:SS'),
                ComDelDate = TO_DATE(#{ComDelDate, jdbcType=VARCHAR}, 'YYYY-MM-DD HH24:MI:SS'),
                ComUpDate = TO_DATE(#{ComUpDate, jdbcType=VARCHAR}, 'YYYY-MM-DD HH24:MI:SS'),
                ComintoDate = #{ComintoDate, jdbcType=VARCHAR},
                ComToCount = #{ComToCount, jdbcType=INTEGER},
                ComStartDate = TO_DATE(#{ComStartDate, jdbcType=VARCHAR}, 'YYYY-MM-DD HH24:MI:SS'),
                ComEndDate = TO_DATE(#{ComEndDate, jdbcType=VARCHAR}, 'YYYY-MM-DD HH24:MI:SS'),
                ComPlace =
                <choose>
                    <when test="ComAddress == '스터디룸'">
                        (select sgicontent1 from tbl_studyginfo where sgiidx = #{currentStudyRoom})
                    </when>
                    <when test="!enroll_company.zonecode.isEmpty() and enroll_company.zonecode != null">
                        #{enroll_company.detailedAddress, jdbcType=INTEGER}
                    </when>
                    <otherwise>
                        #{ComPlace, jdbcType=VARCHAR}
                    </otherwise>
                </choose>,
                ComZipcode =
                <choose>
                    <when test="ComAddress == '스터디룸'">
                        #{ComZipcode, jdbcType=VARCHAR}
                    </when>
                    <when test="!enroll_company.zonecode.isEmpty() and enroll_company.zonecode != null">
                        #{enroll_company.zonecode, jdbcType=VARCHAR}
                    </when>
                    <otherwise>
                        #{ComZipcode, jdbcType=VARCHAR}
                    </otherwise>
                </choose>,
                ComAddress =
                <choose>
                    <when test="ComAddress == '스터디룸'">
                        #{ComAddress, jdbcType=VARCHAR}
                    </when>
                    <when test="!enroll_company.zonecode.isEmpty() and enroll_company.zonecode != null">
                        #{enroll_company.address, jdbcType=VARCHAR}
                    </when>
                    <otherwise>
                        #{ComAddress, jdbcType=VARCHAR}
                    </otherwise>
                </choose>,
                ComReportCount = #{ComReportCount, jdbcType=INTEGER}
            where comidx = #{ComIdx, jdbcType=INTEGER}
    </update>

    <delete id="deleteTogetherStudy" parameterType="map">
        DELETE FROM tbl_TogetherStudy
        WHERE comidx = #{comIdx}
            AND (comidx, midx) NOT IN (
                <foreach collection="groupMemberInfos" item="item" open="(" close=")" separator=",">
                    #{item.comIdx}, #{item.midx}
                </foreach>
            )
    </delete>

    <delete id="deleteTogetherStudyAll" parameterType="int">
        delete from tbl_TogetherStudy where comidx = #{comidx}
    </delete>

    <insert id="insert_comment_question" parameterType="map">
        insert into tbl_community_comment
        values
        (ComComment_seq.NEXTVAL, (select Midx from tbl_member where MemberId = #{sessionId}), #{comIdx}, 1, 1, (#{maxCCGroupNum} + 1), #{comment}, SYSDATE, to_date('9999-12-31 00:00', 'YYYY/MM/DD HH24:MI'), to_date('9999-12-31 00:00', 'YYYY/MM/DD HH24:MI'), 0)
    </insert>

    <insert id="insert_comment_reply" parameterType="map">
        insert into tbl_community_comment
        values
            (ComComment_seq.NEXTVAL, (select Midx from tbl_member where MemberId = #{sessionId}), #{comIdx}, 2, 2, #{currentCommentGroupNum}, #{comment}, SYSDATE, to_date('9999-12-31 00:00', 'YYYY/MM/DD HH24:MI'), to_date('9999-12-31 00:00', 'YYYY/MM/DD HH24:MI'), 0)
    </insert>

    <update id="updateComment_forSelf" parameterType="map">
        update tbl_community_comment set cccontent = #{comment}, ccupdate = SYSDATE where ccidx = #{currentComment}
    </update>

    <update id="deleteComment" parameterType="map">
        update tbl_community_comment set ccdeldate = SYSDATE where (ccidx = #{comment_ccidx} or ccgroupnum = #{comment_ccgroupnum}) and comidx = #{comment_comidx}
    </update>

    <update id="reportComment" parameterType="int">
        update tbl_community_comment set ccreportcount = ccreportcount + 1 where ccidx = #{comment_ccidx}
    </update>

    <insert id="insertTogetherStudy" parameterType="map">
        insert into tbl_TogetherStudy values ((select midx from tbl_member where memberid = #{sessionId}), #{comIdx})
    </insert>

    <delete id="deleteTogetherStudy_forPost" parameterType="map">
        delete from tbl_TogetherStudy where midx = (select midx from tbl_member where memberid = #{sessionId}) and comidx = #{comIdx}
    </delete>

    <update id="deletePost_allPost" parameterType="int">
        update tbl_community set comdeldate = SYSDATE where comidx = #{comIdx}
    </update>

    <update id="deleteComment_allPost" parameterType="int">
        update tbl_community_comment set ccdeldate = SYSDATE where comidx = #{comIdx}
    </update>

    <delete id="deleteTogetherStudy_allPost" parameterType="int">
        delete from tbl_TogetherStudy where comidx = #{comIdx}
    </delete>

    <insert id="insertCommunity" parameterType="map">
        insert into tbl_community (
        comidx,
        comcateidx,
        midx,
        comtitle,
        comcontent,
        comregdate,
        comdeldate,
        comupdate,
        comintodate,
        comtocount,
        comstartdate,
        comenddate,
        complace,
        comzipcode,
        comaddress,
        comreportcount
        ) values (
        Community_seq.NEXTVAL,
        (select comcateidx from tbl_community_category where comcatename = #{boardContents.category1}),
        (select midx from tbl_member where memberid = #{sessionId} and membername = #{sessionName}),
        #{boardContents.title},
        #{boardContents.content},
        SYSDATE,
        to_date('9999-12-31 00:00', 'YYYY-MM-DD HH24:MI'),
        to_date('9999-12-31 00:00', 'YYYY-MM-DD HH24:MI'),
        0,
        #{boardContents.groupCount},
        to_date(#{boardContents.startday}, 'YYYY-MM-DD HH24:MI:SS'),
        to_date(#{boardContents.enddate}, 'YYYY-MM-DD HH24:MI:SS'),
        <choose>
            <when test="boardContents.comAddress == '스터디룸'">
                (select sgicontent1 from tbl_studyginfo where sgiidx = #{currentStudyRoom}),
                #{boardContents.comZipcode},
                #{boardContents.comAddress}
            </when>
            <when test="boardContents.comAddress == '온라인'">
                #{boardContents.comPlace},
                #{boardContents.comZipcode},
                #{boardContents.comAddress}
            </when>
            <otherwise>
                #{enroll_company.detailedAddress},
                #{enroll_company.zonecode},
                #{enroll_company.address}
            </otherwise>
        </choose>,
        0
        )
    </insert>

    <insert id="insertChatName" parameterType="map">
        insert into tbl_chatroom values (ChatRoom_seq.NEXTVAL, (select max(comidx) from tbl_community), #{boardContents.groupName})
    </insert>

    <insert id="insertAlarm" parameterType="map">
        insert into tbl_member_alarm values (MAlarm_seq.NEXTVAL, (select midx from tbl_member where memberid = #{memberId}), #{alarm_title}, #{alarm_content}, SYSDATE)
    </insert>

    <select id="selectChatRoomInfo" parameterType="int" resultType="com.project.SnakeDev.vo.ChatRoomVo">
        select * from tbl_chatroom
        <where>
            <if test="comIdx != 0">
                comidx = #{comIdx}
            </if>
            <if test="comIdx == 0">
                comidx = (select max(comidx) from tbl_community)
            </if>
        </where>
    </select>
</mapper>